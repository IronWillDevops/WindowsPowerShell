$Sender = "Administrator From@example.com"
$Subject = 'Внимание! Скоро истекает срок действия Вашего пароля!'
$BodyTxt1 = 'Срок действия Вашего пароля для<b>'
$BodyTxt2 = '</b>заканчивается через <b>'
$BodyTxt3 = '</b>дней. Не забудьте заранее сменить Ваш пароль в противном случае УЗ будет заблокирована.<br>Если у вас есть вопросы, обратитесь в <a href="http://support.example.com">службу поддержки</a>.<br>Данное письмо не требует ответа.'
$smtpserver ="mx1.example.com"
$warnDays = (get-date).adddays(14)
$2Day = get-date

$Users = Get-ADUser  -filter {Enabled -eq $True -and PasswordNeverExpires -eq $False} -Properties msDS-UserPasswordExpiryTimeComputed, EmailAddress, Name | select Name, @{Name ="ExpirationDate";Expression= {[datetime]::FromFileTime($_."msDS-UserPasswordExpiryTimeComputed")}}, EmailAddress
foreach ($user in $users) {

if (($user.ExpirationDate -lt $warnDays) -and ($2Day -lt $user.ExpirationDate) ) {
$lastdays = ( $user.ExpirationDate -$2Day).days
$EmailBody = $BodyTxt1, $user.name, $BodyTxt2, $lastdays, $BodyTxt3 -join ' '
$encoding = [System.Text.Encoding]::UTF8
   
   Write-Output $user.EmailAddress
   if($user.EmailAddress){
Send-MailMessage -To $user.EmailAddress -From $Sender -SmtpServer $smtpserver -Subject $Subject -Body $EmailBody -BodyAsHtml -Encoding $encoding
}}
}
